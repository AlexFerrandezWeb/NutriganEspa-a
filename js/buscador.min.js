document.addEventListener("DOMContentLoaded",async function(){console.log("Inicializando buscador...");const buscadorInput=document.getElementById("buscar");const suggestionsList=document.getElementById("suggestions");const buscadorBtn=document.querySelector(".buscador-btn");let productos=[];try{const response=await fetch("productos.json");productos=await response.json();console.log("Productos cargados:",productos.length)}catch(error){console.error("Error cargando productos:",error)}function obtenerHistorial(){try{const historial=JSON.parse(localStorage.getItem("historialBusquedas"))||[];return historial.filter(item=>item&&item.id&&item.nombre&&typeof item.precio==="number"&&item.imagen)}catch(error){console.error("Error al cargar historial:",error);return[]}}function guardarEnHistorial(producto){if(!producto||!producto.id||!producto.nombre||!producto.precio||!producto.imagen){console.error("Producto inválido para historial:",producto);return}console.log("Guardando producto en historial:",producto);let historial=obtenerHistorial();const nuevaBusqueda={id:producto.id,nombre:producto.nombre,precio:Number(producto.precio),imagen:producto.imagen,timestamp:(new Date).getTime()};historial=[nuevaBusqueda,...historial.filter(item=>item.id!==producto.id)].slice(0,5);localStorage.setItem("historialBusquedas",JSON.stringify(historial));console.log("Historial actualizado:",historial)}function formatearTiempo(timestamp){const ahora=(new Date).getTime();const diferencia=ahora-timestamp;const minutos=Math.floor(diferencia/6e4);const horas=Math.floor(diferencia/36e5);const dias=Math.floor(diferencia/864e5);if(minutos<1)return"Hace un momento";if(minutos<60)return`Hace ${minutos} ${minutos===1?"minuto":"minutos"}`;if(horas<24)return`Hace ${horas} ${horas===1?"hora":"horas"}`;if(dias===1)return"Ayer";if(dias<7)return`Hace ${dias} días`;return new Date(timestamp).toLocaleDateString()}function mostrarHistorial(){const historial=obtenerHistorial();console.log("Mostrando historial:",historial);if(historial.length>0){suggestionsList.innerHTML=`
                <li class="buscador-li buscador-historial-titulo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                    </svg>
                    Productos vistos recientemente
                </li>
                ${historial.map(item=>{const precio=typeof item.precio==="number"?item.precio.toFixed(2):"0.00";const carrito=JSON.parse(localStorage.getItem("carrito"))||[];const estaEnCarrito=carrito.some(prod=>prod.id===item.id);return`
                        <li class="buscador-li" data-id="${item.id}">
                            <div class="sugerencia-contenedor">
                                <div class="sugerencia-imagen">
                                    <img src="${item.imagen}" alt="${item.nombre}">
                                </div>
                                <div class="sugerencia-info">
                                    <div class="sugerencia-nombre">
                                        ${item.nombre}
                                        ${estaEnCarrito?'<span class="badge-carrito">En carrito</span>':""}
                                    </div>
                                    <div class="sugerencia-detalles">
                                        <span class="sugerencia-precio">${precio}€</span>
                                        <span class="sugerencia-tiempo">${formatearTiempo(item.timestamp)}</span>
                                    </div>
                                </div>
                            </div>
                        </li>
                    `}).join("")}
                <li class="buscador-li buscador-historial-borrar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                    </svg>
                    Borrar historial
                </li>
            `;suggestionsList.style.display="block"}else{suggestionsList.style.display="none"}}buscadorInput.addEventListener("focus",function(){console.log("Focus en buscador");if(this.value.trim().length<2){mostrarHistorial()}});buscadorInput.addEventListener("input",function(){const busqueda=this.value.trim();console.log("Búsqueda:",busqueda);if(busqueda.length<2){mostrarHistorial();return}const sugerencias=productos.filter(producto=>producto.nombre.toLowerCase().includes(busqueda.toLowerCase())||producto.descripcion.toLowerCase().includes(busqueda.toLowerCase()));console.log("Sugerencias encontradas:",sugerencias.length);if(sugerencias.length>0){suggestionsList.innerHTML=sugerencias.map(producto=>`
                <li class="buscador-li" data-id="${producto.id}">
                    <div class="sugerencia-contenedor">
                        <div class="sugerencia-imagen">
                            <img src="${producto.imagen}" alt="${producto.nombre}">
                        </div>
                        <div class="sugerencia-info">
                            <div class="sugerencia-nombre">${producto.nombre}</div>
                            <div class="sugerencia-descripcion">
                                ${producto.descripcion.substring(0,60)}...
                            </div>
                            <div class="sugerencia-detalles">
                                <span class="sugerencia-precio">${producto.precio.toFixed(2)}€</span>
                            </div>
                        </div>
                    </div>
                </li>
            `).join("");suggestionsList.style.display="block"}else{suggestionsList.innerHTML=`
                <li class="buscador-li">No se encontraron productos</li>
            `;suggestionsList.style.display="block"}});suggestionsList.addEventListener("click",function(e){const li=e.target.closest(".buscador-li");if(e.target.closest(".buscador-historial-borrar")){console.log("Borrando historial");localStorage.removeItem("historialBusquedas");suggestionsList.style.display="none";return}if(li&&li.dataset.id){console.log("Producto seleccionado:",li.dataset.id);const producto=productos.find(p=>p.id==li.dataset.id);if(producto){guardarEnHistorial(producto)}window.location.href=`producto.html?id=${li.dataset.id}`}});document.addEventListener("click",function(e){if(!e.target.closest(".buscador")){suggestionsList.style.display="none"}});function realizarBusqueda(){const busqueda=buscadorInput.value.trim();if(busqueda.length>=2){const producto=productos.find(p=>p.nombre.toLowerCase().includes(busqueda.toLowerCase()));if(producto){guardarEnHistorial(producto);window.location.href=`producto.html?id=${producto.id}`}}}buscadorBtn.addEventListener("click",realizarBusqueda);buscadorInput.addEventListener("keypress",function(e){if(e.key==="Enter"){realizarBusqueda()}})});